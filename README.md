
# Fleet Provisioning for AWS IoT and STM32 Microcontroller

## 1. Overview
This project provides an automated setup for AWS IoT Fleet Provisioning for STM32 Microcontrollers devices. By using CloudFormation, claim certificates, and an IoT provisioning template, this project enables scalable, secure, and automated provisioning of IoT devices, allowing them to self-register and maintain secure communication through AWS IoT.

Use this [link]((https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html)) to learn more about [Device provisioning MQTT API
](https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html)

Use this [link](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html) to learn more about AWS Fleet Provisioning and [Provisioning by claim](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#claim-based)

This example use [Provisioning by claim](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#claim-based)

This is an adaptation of the FreeRTOS [AWS IoT Fleet Provisioning Demo
](https://www.freertos.org/Documentation/03-Libraries/04-AWS-libraries/06-AWS-IoT-Fleet-Provisioning/03-Fleet-provisioning-demo). 

The main differences vs the [AWS IoT Fleet Provisioning Demo
](https://www.freertos.org/Documentation/03-Libraries/04-AWS-libraries/06-AWS-IoT-Fleet-Provisioning/03-Fleet-provisioning-demo):
- It runs on STM32 and on top of the AWS [iot-reference-stm32u5](https://github.com/FreeRTOS/iot-reference-stm32u5)
- Automate the process using scripts and CloudFormation to create the required AWS resources. This significantly reduces time and minimizes errors.
- Devices are automatically register to a ThingGroup in AWS

## 2. Fleet Provisioning Flow
>Note: This process is done only once and all the IoT devices can use the same firmware and claim certificate to autoregister and connect to AWS. 

> OpenSSL is used to generate the CSR to ensure that AWS generates a claim certificate compatible with the firmware running on STM32.

>A binay that contains all the proper configuration can be buit too. Means, a single binary can be used for all the devices.

The User will need to:
1. Use openSSL to generate a private key and CSR file
2. Use the CSR file to generate a certificate. The certificate is downloaded and saved on your PC. The certificate will be saved and activeted on AWS. This is the calim certificate and will be used by all the IoT devices to auto-register themself with AWS IoT
3. Create a Fleet Provisioning Template using Cloud Formation.
4. Update the STM32 Firmware with the Fleet Provisioning tempalate name and rebuild the firmware.
5. Flash the Firmware to STM32
6. Use a serial terminal to:
   * Upload the Fleet Provisioning private key
   * Upload the Fleet Provisioning certificate
   * Upload AWS RootCA certificate
   * Set Wi-Fi SSID
   * Set Wi-Fi Password
   * Set AWS endpoint
   * Set MQTT Port
   * Set the ThingGroup Name

When the STM32 device restarts, it will:
1. Connect to Wi-Fi.
2. Use the Fleet Provisioning certificate to establish a connection with AWS.
3. Generate a `thing_name` based on the device's Unique ID (UID) and save it to internal flash memory.
4. Generate a public-private key pair and save them to internal flash memory.
5. Generate a Certificate Signing Request (CSR) and send it to AWS.
6. Receive a new certificate from AWS.
7. Save the newly received certificate to internal flash memory.
8. Send a registration request to AWS.
9. Reset the STM32 after receiving registration confirmation from AWS.

Upon reboot, the STM32 device will use the new certificate to connect to AWS IoT Core and start running the application.

## 3. Prerequisites
- **[B-U585I-IOT02A](https://www.st.com/en/evaluation-tools/b-u585i-iot02a.html)**
- **[AWS Account](https://aws.amazon.com/)**: Access to an AWS account with permissions to manage IAM, IoT, and CloudFormation stacks.
- **[AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)**: Install and [configure](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-quickstart.html) the AWS CLI on your local machine.
- **[Git Bash](https://git-scm.com/downloads)**: Required for Windows users to provide a Unix-like shell compatible with the scripts.
- **OpenSSL**: Required to generate keys and CSR file

## 4. Files
Description of the files on this repository
1. **config.json**
   - Configuration file for Fleet Provisioning.

2. **gen_csr.sh**
   - Uses OpenSSL to generate a private key, public key, and a CSR (Certificate Signing Request) file.

3. **createFleetProvisioningStack.sh**
   - Creates the necessary CloudFormation stack to provision resources in AWS for IoT Fleet Provisioning. It utilizes the CSR file generated by `gen_csr.sh` and the configuration specified in `config.json`.

4. **template.yaml**
   - CloudFormation template for Fleet Provisioning resources. This file is updated by the createFleetProvisioningStack.sh

5. **deviceCleanup.sh**
   - Cleans up IoT resources by deleting the IoT Thing and its certificates.

6. **b_u585_iota02_aws_iot.bin**
   - Prebuilt binary with `provisioningTemplateName` set to `DEFULT_FP_TemplateName`

---

## 5. Setup Steps

### 5.1. Clone the Repositories

```bash
git clone https://github.com/SlimJallouli/STM32_FleetProvisioning
```

### 5.2. Generate a CSR
```bash
cd STM32_FleetProvisioning
```

use the `gen_csr.sh` to generate private-key.pem,  public-key.pem and a csr.pem file

```bash
./gen_csr.sh
```

this will create `claim-certs` folder that contains `public.pem.key`, `private.pem.key` and `csr.pem`

### 5.3. Update config.json
open `config.json` with a text editor and update:
- StackName
- ThingGroupName
- provisioningTemplate
>NOTE: Set the `provisioningTemplateName` to `DEFULT_FP_TemplateName` to use the provided `b_u585_iota02_aws_iot.bin`

### 5.4. Create the CloudFormation Stack
Use `createFleetProvisioningStack.sh` to automte the setup of AWS IoT Fleet Provisioning by creating a CloudFormation stack, generating claim certificates, and attaching the necessary IoT policies.

`createFleetProvisioningStack.sh` reads the `STACK_NAME` and `PROVISION_TEMPLATE_NAME` from `config.json`, use the `claim-certs/csr.pem` file to generate the claim certificate and use the `template.yaml` to create the Fleet Provisioning template using CloudFormation

The claim certificate is saved at `claim-certs\claim.pem.crt`

```bash
./createFleetProvisioningStack.sh
```

### 5.5 Flash the b_u585_iota02_aws_iot.bin

You can use the `b_u585_iota02_aws_iot.bin` if the `provisioningTemplateName` was set to `DEFULT_FP_TemplateName` when you created the Fleet Provisionin template earlier. You can drag and drop the file to your **[B-U585I-IOT02A](https://www.st.com/en/evaluation-tools/b-u585i-iot02a.html)**

![alt text](<Screenshot 2025-02-14 081745-1.png>)


You need to rebuild the poject if the `provisioningTemplateName` is different from `DEFULT_FP_TemplateName`

### 5.6. Rebuild the project
If `provisioningTemplateName` is different from `DEFULT_FP_TemplateName` then you need to rebuild the project

clone the b_u585_iota02_aws_iot repo

```bash
git clone https://github.com/SlimJallouli/b_u585_iota02_aws_iot.git --recurse-submodules
```

- open the `b_u585_iota02_aws_iot` project with STM32CubeIDE
- open `\Common\app\FleetProvisioning\fleet_provisioning_config.h` 
- replace the ***#define democonfigPROVISIONING_TEMPLATE_NAME "ProvisionTemplate"*** with your provision template name as you set it up in `config.json` file. This is important or your device will not be able to register itself with AWS.

![alt text](<Screenshot 2025-02-05 093504.png>)

- Make sure to select the FleetProvisioning option

![alt text](<Screenshot 2025-02-13 143120.png>)

- rebuild, flash and run the project

## 6 Configure your boards
To ensure your STM32 board properly connects to AWS, you must configure your board by sending the following over UART using AWS CLI commands:

 1. - Claim certificate.
 2. - Claim private key.
 3. - AWS RootCA.
 4. - AWS endpoint.
 5. - MQTT port.
 6. - Thing Group Name.
 7. - Wi-Fi SSID.
 8. - Wi-Fi password.
 9. - provision state.
 10. - Commit the changes.
 11. - Reset the board.

You have two options to configure your board:

1. - Manual Option: Manually send each command through a serial terminal.
2. - Automated Option: Use the provided configuration script to automate the process.

### 6.1 Manual option
#### 6.1.1. Upload the claim certificate to STM32 
- open `claim-certs\claim.pem.crt` on text editor

- construct the command as following and then use serial terminal to send it to STM32
```
pki import cert fleetprov_claim_cert
-----BEGIN CERTIFICATE-----
MIIEpAIBAAKCAQEA1WUKouJ2A6kTUkFKTyydStQ78zSsYMZK13SbnkcyPl8e5tiU
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
PFSoDLLTuqihG33SKAGGJVdARcCAQNYgycVe6ZpPLVzR+feZu3G5Vg==
-----END CERTIFICATE-----
```
#### 6.1.2. Upload the claim private key to STM32
- open `claim-certs\private-key.pem` on text editor

- construct the command as following and then use serial terminal to send it to STM32
```
pki import key fleetprov_claim_key
-----BEGIN EC PRIVATE KEY-----
MHXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX49
AwXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX4r
3CSXXXXXXXXXXXXXXXXXiUQ==
-----END EC PRIVATE KEY-----
```

#### 6.1.3. Import the Amazon Root CA Certificate
Use the *pki import cert root_ca_cert* command to import the Root CA Certificate.
For this demo, we recommend you use the ["Starfield Services Root Certificate Authority - G2](https://www.amazontrust.com/repository/SFSRootCAG2.pem) Root CA Certificate which has signed all four available Amazon Trust Services Root CA certificates.

Copy/Paste the contents of [SFSRootCAG2.pem](https://www.amazontrust.com/repository/SFSRootCAG2.pem) into your serial terminal after issuing the ```pki import cert``` command.
```
> pki import cert root_ca_cert
-----BEGIN CERTIFICATE-----
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
-----END CERTIFICATE-----
```

#### 6.1.4. Set Config
- Use a serial terminal to:
   * Set Wi-Fi SSID
   * Set Wi-Fi Password
   * Set AWS endpoint
   * Set MQTT Port
   * Set the ThingGroup Name

>Not: You don't need to set the thing_name as the Fleet Provisioning firware running on STM32 will generate a unique thing_name per device. It uses the device Unique ID to generate the thing_name.

The thing name will be in the form of `stm32u5-XXXXXXXXXXXXXXXXXXXXXXXX`

```
conf set mqtt_endpoint abcdefjhtvew8t-ats.iot.us-west-2.amazonaws.com 
conf set mqtt_port 8883
conf set provision_state 0
conf set wifi_ssid <Your Wi-Fi SSID>
conf set wifi_credential <Your Wi-Fi Password>
conf set thing_group_name <Your ThingGroupName>
conf commit
reset
```
### 6.2 Automated Option
#### 6.2.1 Update the config.json file
Open the `config.json` file and update the follwing

  * "mqtt_endpoint": "abcdefjhtvew8t-ats.iot.us-west-2.amazonaws.com",
  * "mqtt_port": 8883,
  * "provision_state": 0,
  * "wifi_ssid": "MySSID",
  * "wifi_credential": "MyPSWD",
  * "thing_group_name": "MyThingGroup",
  * "portName": "MyBoardComPort",
  * Update the `certificateFile`, `privateKeyFile` and `root_ca_cert` paths depending on your OS (Default Windows)

![alt text](<Screenshot 2025-02-13 145343.png>)


  #### 6.2.2 Run the config script
  Dependong on you operating systrem, run `config.ps1` on windows, `config.sh` on Linux