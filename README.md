
# Fleet Provisioning for AWS IoT and STM32 Microcontroller

## 1. Overview
This project provides an automated setup for AWS IoT Fleet Provisioning for STM32 Microcontrollers devices. By using CloudFormation, claim certificates, and an IoT provisioning template, this project enables scalable, secure, and automated provisioning of IoT devices, allowing them to self-register and maintain secure communication through AWS IoT.

Use this [link]((https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html)) to learn more about [Device provisioning MQTT API
](https://docs.aws.amazon.com/iot/latest/developerguide/fleet-provision-api.html)

Use this [link](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html) to learn more about AWS Fleet Provisioning and [Provisioning by claim](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#claim-based)

This example use [Provisioning by claim](https://docs.aws.amazon.com/iot/latest/developerguide/provision-wo-cert.html#claim-based)


## 2. Fleet Provisioning Flow
>Note: This process is done only once and all the IoT devices can use the same firmware to connect to AWS without any further configuration. No other actions are needed on AWS side too.

The User will need to:
1. Use openSSL to generate a private key and CSR file
2. Use the CSR file to generate a certificate. The certificate is downloaded and saved on your PC. The certificate will be saved and activeted on AWS. This is the calim certificate and will be used by all the IoT devices to auto-register themself with AWS IoT
3. Create a Fleet Provisioning Template using Cloud Formation.
4. Update the STM32 Firmware with the Fleet Provisioning tempalate name and rebuild the firmware.
5. Flash the Firmware to STM32
6. Use a serial terminal to:
   * Upload the Fleet Provisioning private key
   * Upload the Fleet Provisioning certificate
   * Set Wi-Fi SSID
   * Wi-Fi Password
   * Set AWS endpoint
   * Set and MQTT Port

>A single binay that contains all the proper configuration can be buit too. Means, a single binary can be used for all the devices.

When the STM32 device restarts, it will:
1. Connect to Wi-Fi.
2. Use the Fleet Provisioning certificate to establish a connection with AWS.
3. Generate a Certificate Signing Request (CSR) and send it to AWS.
4. AWS will respond with a new certificate.
5. STM32 save the newly received certificate in its internal flash memory.
6. Send a Register request to AWS.
7. STM32 reset after receiving the registration confirmation from AWS.

When the STM32 device reboots, it will use the new certificate to connect to AWS IoT Core and begin running the application.

## 3. Prerequisites
- **[B-U585I-IOT02A](https://www.st.com/en/evaluation-tools/b-u585i-iot02a.html)**
- **[AWS Account](https://aws.amazon.com/)**: Access to an AWS account with permissions to manage IAM, IoT, and CloudFormation stacks.
- **[AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)**: Install and [configure](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-quickstart.html) the AWS CLI on your local machine.
- **[Git Bash](https://git-scm.com/downloads)**: Required for Windows users to provide a Unix-like shell compatible with the scripts.
- **OpenSSL**: Required to generate keys and CSR file

## 4. Files
Description of the files on this repository
1. **config.json**
   - Configuration file for Fleet Provisioning.

2. **gen_csr.sh**
   - Uses OpenSSL to generate a private key, public key, and a CSR (Certificate Signing Request) file.

3. **createFleetProvisioningStack.sh**
   - Creates the necessary CloudFormation stack to provision resources in AWS for IoT Fleet Provisioning. It utilizes the CSR file generated by `gen_csr.sh` and the configuration specified in `config.json`.

5. **template.yaml**
   - CloudFormation template for Fleet Provisioning resources. This file is updated by the createFleetProvisioningStack.sh

6. **deviceCleanup.sh**
   - Cleans up IoT resources by deleting the IoT Thing and its certificates.

---

## 5. Setup Steps

### 5.1. Clone the Repositories
Clone these two repositories:

```bash
git clone https://github.com/SlimJallouli/aware_demo.git --recurse-submodules
```
```bash
git clone https://github.com/SlimJallouli/STM32_FleetProvisioning
```

### 5.2. Generate a CSR
```bash
cd STM32_FleetProvisioning
```

use the `gen_csr.sh` to generate private-key.pem,  public-key.pem and a csr.pem file

```bash
./gen_csr.sh
```

this will create `claim-certs` folder that contains `public.pem.key`, `private.pem.key` and `csr.pem`

### 5.3. Update config.json
open `config.json` with a text editor and update:
- StackName
- ThingGroupName
- provisioningTemplate

### 5.4. Create the CloudFormation Stack
Use `createFleetProvisioningStack.sh` to automte the setup of AWS IoT Fleet Provisioning by creating a CloudFormation stack, generating claim certificates, and attaching the necessary IoT policies.

`createFleetProvisioningStack.sh` reads the `STACK_NAME` and `PROVISION_TEMPLATE_NAME` from `config.json`, use the `claim-certs/csr.pem` file to generate the claim certificate and use the `template.yaml` to create the Fleet Provisioning template using CloudFormation

The claim certificate is saved at `claim-certs\claim.pem.crt`

```bash
./createFleetProvisioningStack.sh
```
### 5.5. Rebuild the project
- open the `aware_demo` with STM32CubeIDE
- open `\Common\app\FleetProvisioning\fleet_provisioning_config.h` 
- replace the ***#define democonfigPROVISIONING_TEMPLATE_NAME "ProvisionTemplate"*** with your provision template name as you set it up in `config.json` file
- rebuild, flash and run the project

![alt text](<Screenshot 2025-02-05 093504.png>)

### 5.6. Upload the certificate to STM32 
- open `claim-certs\claim.pem.crt` on text editor

- construct the command as following and then use serial terminal to send it to STM32
```
pki import cert fleetprov_claim_cert
-----BEGIN CERTIFICATE-----
MIIEpAIBAAKCAQEA1WUKouJ2A6kTUkFKTyydStQ78zSsYMZK13SbnkcyPl8e5tiU
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
PFSoDLLTuqihG33SKAGGJVdARcCAQNYgycVe6ZpPLVzR+feZu3G5Vg==
-----END CERTIFICATE-----
```
### 5.7. Upload the private key on to STM32
- open `claim-certs\private-key.pem` on text editor

- construct the command as following and then use serial terminal to send it to STM32
```
pki import key fleetprov_claim_key
-----BEGIN EC PRIVATE KEY-----
MHXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX49
AwXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX4r
3CSXXXXXXXXXXXXXXXXXiUQ==
-----END EC PRIVATE KEY-----
```
### 5.8. Set Config
- Use a serial terminal to:
   * Upluad the Fleet Provisioning private key
   * Upluad the Fleet Provisioning certificate
   * Set Wi-Fi SSID
   * Wi-Fi Password
   * Set AWS endpoint
   * Set MQTT Port.

>Not: You don't need to set the thing_name as the Fleet Provisioning firware running on STM32 will generate a unique device ID per device. It uses the device Unique ID to generate the thing_name. This autogenerated thing_name will be used by the Firmware Running on STM32 to register itself with AWS IoT core.

The thing name will be in the form of `stm32u5-XXXXXXXXXXXXXXXXXXXXXXXX`

```
conf set mqtt_endpoint abcdefjhtvew8t-ats.iot.us-west-2.amazonaws.com 
conf set mqtt_port 8883
conf set provision_state 0
conf set wifi_ssid <Your Wi-Fi SSID>
conf set wifi_credential <Your Wi-Fi Password>
conf set thing_group_name <Your ThingGroupName>
conf commit
reset
```
